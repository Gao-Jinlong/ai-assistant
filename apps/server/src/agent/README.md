# agent 对话流程

## dify 对话流程参考
1. 初始化模型等配置信息
   - 获取应用配置和数据库记录
   - 提取用户输入、查询内容、上传文件等信息
2. 记忆管理，恢复历史对话
   - 如果存在对话ID，创建记忆管理器
   - 用于维护对话历史，让AI能够记住之前的对话内容
3. 内容审核
   - 对用户输入进行审核，判断是否包含敏感信息
   - 如果包含敏感信息，则返回错误信息
4. 标注回复处理？
   - 对回复进行标注处理，判断是否包含敏感信息
   - 如果包含敏感信息，则返回错误信息
5. 外部数据工具处理
   - 处理外部数据工具，动态填充输入变量
   - 支持从外部API获取实时数据
6. 知识库检索
   - 从配置的知识库中检索相关内容
   - 将检索到的上下文信息添加到提示中
7. prompt 组装
   - 将所有信息组装成最终的提示消息
   - 包括：模板、输入、查询、文件、记忆、外部数据、知识库上下文
8. 二次审核？
   - 对组装后的完整提示进行二次审核
   - 确保AI生成的内容符合规范
9. Token 计算优化
   - 重新计算最大token数
   - 确保不超过模型的token限制
10. 模型调用
    - 创建模型实例
    - 调用大语言模型进行推理
    - 支持流式和非流式输出
11. 结果处理
    - 处理模型返回的结果
    - 通过队列管理器发送给前端
